""!=location&&null==location.hostname.match(".")&&window.stop&&window.stop();var storage_marker="dv2",game_paused=0,game_speed=1,loop_inited=0,changed_tab=0,interacted=0,clicking=0,resetting=0,stab=1,changed_stab=0,buying="";function switch_world(e){d.game.world.curr=e,changed_tab=1}function switch_tab(e=1){e>0&&(d.game.tab["curr"+d.game.world.curr]=e),changed_tab=1}function switch_stab(e=1){stab=e,changed_stab=1,gebi("gmain").innerHTML=""}function click_skill(e,l=0){if(1!=clicking){clicking=1,canrun=0;var a=d.skill[e];1==a.unlock&&0==a.running&&a.value<a.max&&(null!=a.cost?1==check_cost(e)&&(consume_cost(e),canrun=1):canrun=1),1==canrun?a.running=1:clicking=0,0==l&&(1==a.auto?a.auto=2:2==a.auto&&(a.auto=1)),clicking=0}}function update_ui(){if(1==resetting){setTimeout("update_ui()",100);return}var e=gebi("gmain"),l=d.game.world.curr,a=d.game.tab["curr"+l],i="k"+l+a;if("k15"!=i){for(var s=Object.keys(d.skill),n=0;n<s.length;n++)if(s[n].substring(0,3)==i||null!=d.game.battle&&(null!=d.skill[s[n]].attack||null!=d.skill[s[n]].enemy)){var g=d.skill[s[n]];if(1==g.unlock){var u="0"==s[n].substring(3,4)?1:0,_=null!=skill[s[n]].gold&&1==skill[s[n]].gold?1:0,o=null!=skill[s[n]].room&&1==skill[s[n]].room?1:0,c=null!=skill[s[n]].ssk&&1==skill[s[n]].ssk?1:0,k=null!=skill[s[n]].enemy&&1==skill[s[n]].enemy?1:0,b=null!=skill[s[n]].attack?1:0,p=null!=skill[s[n]].nolimit?1:0,$=null!=skill[s[n]].timer?1:0,f=null!=d.skill[s[n]].rp?1:0,x=null!=d.skill[s[n]].rm?1:0;if(1==k&&d.game.battle!=s[n])continue;if(null==gebi("gubox-"+s[n])){var y='<div id="gubox-'+s[n]+'" class="gubox noselect hand">';y+='<div id="gupanel-'+s[n]+'" class="gupanel hand" onclick="click_skill(\''+s[n]+'\');"><div id="gubgbar-'+s[n]+'" class="gubgbar clr-'+i+"d "+(1==k?"enemy":"")+" "+(1==o?"room":"")+'"></div>'+(1==k&&1==$?'<div id="guxpbgx-'+s[n]+'" class="gubar timer"><div id="guxpx-'+s[n]+'" class="guxp timer"></div></div>':"")+'<div id="guxpbg-'+s[n]+'" class="gubar '+(1==k?"enemy":"")+'"><div id="guxp-'+s[n]+'" class="guxp clr-'+i+"c "+(1==k?"enemy":"")+" "+(1==o?"room":"")+'"></div></div>'+(1==k?'<div class="guenemy"><img src="img/ico-e.png"></div>':"")+'<div class="gutitle p5 clr-'+i+'a"><b>'+skill[s[n]].title+'</b><span id="guauto-'+s[n]+'" class="guauto"></span> '+(1==u||1==b?"":' &nbsp; <div id="gulvlsmax-'+s[n]+'" class="gulvls"></div><div id="gulvls-'+s[n]+'" class="gulvls '+(1==k?"enemy":"")+'"><span id="gulvl-'+s[n]+'"></span> / <span id="gumax-'+s[n]+'"></span></div>')+(0==b?"":' &nbsp; <div id="gudice-'+s[n]+'" class="gulvls gudice"></div>')+'</div><div class="gutext p5"><span id="gutype-'+s[n]+'" class="gutype"></span> - '+skill[s[n]].text+'</div><div class="gucbar p5">'+(0==k||1==k&&1==$?'<img src="img/ico-time.png"> <span id="gutime-'+s[n]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(1==k&&1==f?'<img src="img/ico-rp.png"> <span id="gurp-'+s[n]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(1==k&&1==x?'<img src="img/ico-rm.png"> <span id="gurm-'+s[n]+'" class="gutime"></span> &nbsp; &nbsp;':"")+((1==u||1==o)&&0==k?'<img src="img/ico-speed.png"> <span id="guspeed-'+s[n]+'" class="gutime"></span> &nbsp; &nbsp;':"")+((1==u||1==o)&&0==k?'<img src="img/ico-add.png"> <span id="guadd-'+s[n]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(0==u&&1==b&&"a999"!=s[n]?'<img src="img/ico-atk.png"> <span id="guatk-'+s[n]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(0==u&&1==b&&"a999"!=s[n]?'<img src="img/ico-acc.png"> <span id="guacc-'+s[n]+'" class="gutime"></span> &nbsp; &nbsp;':"")+(0==u&&1==b&&"a999"!=s[n]?'<img src="img/ico-crit.png"> <span id="gucrit-'+s[n]+'" class="gutime"></span> &nbsp; &nbsp;':"")+'<span id="gucost-'+s[n]+'" class="gucost"></span></div></div></div>',c?gebi("gubox-"+i+"0").insertAdjacentHTML("afterend",y):_||o||k?e.innerHTML=y+e.innerHTML:e.innerHTML+=y}var L=g.value>=g.max&&0==u?1:0,T="",M=1;if(1==g.running&&(M=0),null!=g.cost&&!L&&0==k){for(var H=Object.keys(g.cost),w="",S=0;S<H.length;S++){var I=H[S].substring(0,3),P=skill[H[S]].alt,A=d.skill[H[S]].value,E=g.cost[H[S]];w+='<span class="clr-'+I+(A>=E?"a":"b")+'">'+E+" "+P+"</span> &nbsp; &nbsp;",A<E&&(M=0)}T=""+w}var B=g.curr/g.need*100+"%";if(gebi("guxp-"+s[n]).style.width=B,gebi("gubgbar-"+s[n]).style.width=B,1==$){var C=skill[s[n]].timer;d.game.tree.t41>0&&(C+=d.game.tree.t41);var D=g.curr2/C*100+"%";gebi("guxpx-"+s[n]).style.width=D,gebi("gubgbar-"+s[n]).style.width=D}if(g.auto>0&&(gebi("guauto-"+s[n]).innerHTML=1==g.auto?" (Auto)":" (Paused)"),(0==u||1==k)&&(L&&0==b?(show("gulvlsmax-"+s[n]),gebi("gulvlsmax-"+s[n]).innerHTML="MAX",hide("gulvls-"+s[n])):0==b&&(hide("gulvlsmax-"+s[n]),show("gulvls-"+s[n]),1==k?(gebi("gulvl-"+s[n]).innerHTML=g.need-g.curr,gebi("gumax-"+s[n]).innerHTML=g.need):(gebi("gulvl-"+s[n]).innerHTML=g.value,gebi("gumax-"+s[n]).innerHTML=g.max))),1==p&&(show("gulvlsmax-"+s[n]),gebi("gulvlsmax-"+s[n]).innerHTML="UNLIMITED",hide("gulvls-"+s[n])),(1==u||1==o)&&(gebi("guspeed-"+s[n]).innerHTML=stotime(g.speed)),(1==u||1==o)&&(gebi("guadd-"+s[n]).innerHTML=g.gain),1==k&&1==f&&(gebi("gurp-"+s[n]).innerHTML=g.rp),1==k&&1==x&&(gebi("gurm-"+s[n]).innerHTML=g.rm),1==b&&"a999"!=s[n]){var N=bonus_ap(s[n])+bonus_am(s[n]);gebi("guatk-"+s[n]).innerHTML=g.attack+(N>0?' <span class="bonus">(+'+N+")</span>":"")}if(1==b&&"a999"!=s[n]&&(gebi("guacc-"+s[n]).innerHTML=g.acc+"%"),1==b&&"a999"!=s[n]&&(gebi("gucrit-"+s[n]).innerHTML=g.crit+"x"),1!=L&&0==k&&(gebi("gutime-"+s[n]).innerHTML=stotime(g.need)),1!=L&&1==k&&1==$){var C=skill[s[n]].timer;d.game.tree.t41>0&&(C+=d.game.tree.t41),gebi("gutime-"+s[n]).innerHTML=stotime(C)}1==L&&0==b?gebi("gubox-"+s[n]).classList.add("maxed"):gebi("gubox-"+s[n]).classList.remove("maxed"),1==_?gebi("gubox-"+s[n]).classList.add("gold"):gebi("gubox-"+s[n]).classList.remove("gold"),1==o?gebi("gubox-"+s[n]).classList.add("room"):gebi("gubox-"+s[n]).classList.remove("room"),1==k?gebi("gubox-"+s[n]).classList.add("enemy"):gebi("gubox-"+s[n]).classList.remove("enemy"),1==d.skill.k1221.value&&1==L&&0==_&&0==b&&hide("gubox-"+s[n]),""!=T&&(gebi("gucost-"+s[n]).innerHTML=T),M?gebi("gupanel-"+s[n]).classList.add("afford"+(1==o?"x":"")):(gebi("gupanel-"+s[n]).classList.remove("afford"),gebi("gupanel-"+s[n]).classList.remove("affordx"));var w="Skill";1==k&&(w=""),1==o&&(w="Adventure"),1==_&&(w="Trait"),gebi("gutype-"+s[n]).innerHTML=w,null!=d.game.battle?null==g.attack&&null==g.enemy?gebi("gubox-"+s[n]).classList.add("bhide"):gebi("gubox-"+s[n]).classList.remove("bhide"):(null==g.attack&&g.enemy,gebi("gubox-"+s[n]).classList.remove("bhide"))}}}else{if(null==gebi("divspx")){var y='<div id="divspx"><br>You have <b id="balsp" class="bigger clr-'+i+'a"></b> Soul Points<br><i class="smaller">(you can only spend SP at the beginning of cycles)</i><br><br>Last cycle completed as <b class="clr-k15a">'+treetab[d.game.lastform]+'</b><br><i class="smaller">(cheaper buy for all '+treetab[d.game.lastform]+' traits)</i><br><br><br><span class="smaller">Available Traits</span><br></div>';e.innerHTML+=y}gebi("balsp").innerHTML=d.skill.sp.value;for(var n=1;n<=treetab.length-1;n++)if(null==gebi("stab-"+n)){var y='<div id="stab-'+n+'" class="gmenu stab smaller '+(stab==n?"stactive":"")+' p5" onclick="switch_stab('+n+')">'+treetab[n]+"</div>";e.innerHTML+=y}if(stab>0)for(var n=1;n<=9;n++){var R="t"+stab+n;if(null!=tree[R]){var X=get_stabcost(R);if(null==gebi("ttbox-"+R)){var y='<div id="ttbox-'+R+'" class="gubox noselect hand"><div id="ttpanel-'+R+'" class="gupanel p10" onclick="trybuy(\''+(can_sp(X)?R:"")+'\');"><div class="gutitle ttt p5">'+tree[R].title+' <div id="ttlvl-'+R+'" class="ttlvl"></div></div><div class="gutext p5">'+tree[R].text+'</div><div class="gucbar p5"><span id="ttcost-'+R+'" class="gutime tttcost"></span></div><div id="ttbuy-'+R+'" style="display:none;" class="ttbuy hand" '+(can_sp(X)?"onclick=\"performbuy('"+R+"'); event.stopPropagation();\"":"")+"><br><br><b>Confirm Buy</div></div></div>";e.innerHTML+=y}var Y=" &nbsp; "+(d.game.tree[R]<tree[R].max?"":'<span class="smaller">(MAXED)</span> &nbsp;')+" "+(null!=d.game.tree[R]?d.game.tree[R]:"NAN")+" / "+tree[R].max;gebi("ttlvl-"+R).innerHTML=Y,gebi("ttcost-"+R).innerHTML=""+X+" Soul Point(s)",can_sp(X)&&d.game.tree[R]<tree[R].max?gebi("ttpanel-"+R).classList.add("afford"):gebi("ttpanel-"+R).classList.remove("afford")}}if(null==gebi("newcycle")&&0==d.skill.k110.unlock){var y='<br><br><input id="newcycle" type="button" class="gbtn" value="Begin Journey" onclick="apply_tree();" hide(\'gnoverlay\');">';e.innerHTML+=y}d.game.ginfo_open=1}setTimeout("update_ui()",15)}function update_ui_delay(){if(1==resetting){setTimeout("update_ui_delay()",100);return}"none"!=gebi("gmisc2").style.display&&(gebi("tick").innerHTML=stotime(round(d.game.tick/100)),gebi("stage").innerHTML=d.game.stage),1==d.game.ginfo_open?(show("ginfo"),show("footer")):(hide("ginfo"),hide("footer")),1==d.game.gtab_open&&null==d.game.battle?show("gtab"):hide("gtab"),1==d.game.gworld_open&&null==d.game.battle?show("gworld"):hide("gworld");for(var e=Object.keys(d.skill),l=0;l<e.length;l++)if(0!=d.skill[e[l]].unlock){var a="0"==e[l].substring(3,4)?1:0,i=e[l].substring(0,3);if(1==a){null==gebi("inf-"+e[l])&&(_='<div id="inf-'+e[l]+'" class="ginfbar"><div id="gibgbar-'+e[l]+'" class="gubgbar clr-'+i+'d"></div> <b>'+skill[e[l]].alt+'</b>: <span id="infc-'+e[l]+'" class="infc"></span></div>',gebi("ginfo").innerHTML+=_);var s=d.skill[e[l]].value/d.skill[e[l]].max*100+"%";gebi("gibgbar-"+e[l]).style.width=s,gebi("infc-"+e[l]).innerHTML=round2(d.skill[e[l]].value)+" / "+round(d.skill[e[l]].max)}}if(0!=d.skill.xp.need){null==gebi("inf-xp")&&(_='<div id="inf-xp" class="ginfbar"><div id="gibgbar-xp" class="gubgbar clr-xp"></div> <b><span id="infc-lvl" class="infc"></span> Exp.</b>: <span id="infc-xp" class="infc"></span></div>',gebi("ginfo").innerHTML+=_);var s=d.skill.xp.curr/d.skill.xp.need*100+"%";gebi("gibgbar-xp").style.width=s,gebi("infc-xp").innerHTML=round2(d.skill.xp.curr)+" / "+round(d.skill.xp.need),gebi("infc-lvl").innerHTML="Lvl "+d.game.player.lvl+" - "}if(1==changed_tab){gebi("gmain").innerHTML="",changed_tab=0;var n=gebi("gtab");n.innerHTML="";var g=d.game.world.curr,u=d.game.tab["curr"+g];for(l=1;l<=5;l++)if(1==d.game.tab["open"+g+l]){var _='<div id="gtab'+g+l+'" class="gmenu p5 '+(l==u?"active clr-k"+g+u+"d":"")+'" onclick="switch_tab('+l+');"><img src="img/ico-'+g+l+'.png"></div>';n.innerHTML+=_}gebi("gmain").innerHTML=""}setTimeout("update_ui_delay()",100)}function gameloop(){if(1==resetting){setTimeout("gameloop()",100),resetting=0;return}if(1==d.game.paused){setTimeout("gameloop()",10);return}progress(),clicking=0,d.game.tick++,d.game.tick%(100*save_interval)==0&&savegame(),setTimeout("gameloop()",10)}function progress(){progress_check();for(var e=0,l=Object.keys(d.skill),a=0;a<l.length;a++)if(0!=(r=d.skill[l[a]]).unlock){var i="0"==l[a].substring(3,4)?1:0;1==r.auto&&0==r.running&&r.value<r.max&&click_skill(l[a],1),1==r.running&&(2!=r.auto&&(r.curr+=r.speed/100*game_speed),r.curr>=r.need&&(r.curr=r.need,r.running=0,r.value<r.max&&(r.value+=r.gain,r.value=round2(r.value),r.value>r.max&&(r.value=r.max),r.curr=0,e=1,0==i&&up_skill(l[a]))))}if(null!=d.game.battle&&null!=skill[d.game.battle].timer){var s=d.skill[d.game.battle],n=skill[d.game.battle].timer;d.game.tree.t41>0&&(n+=d.game.tree.t41),s.curr2<n&&(s.curr2+=.01,s.curr2>=n&&(s.curr2=0,up_skill("a998")))}stage_check()}function apply_tree(){if(d.game.tree.t11>0&&(d.skill.k120.speed+=.2*d.game.tree.t11),d.game.tree.t12>0)for(var e=Object.keys(d.skill),l=0;l<e.length;l++)"e"==e[l].substr(0,1)&&(null!=d.skill[e[l]].rm&&(d.skill[e[l]].rm-=.5*d.game.tree.t12),d.skill[e[l]].rm<0&&(d.skill[e[l]].rm=0));if(d.game.tree.t13>0)for(var e=Object.keys(d.skill),l=0;l<e.length;l++)"a"==e[l].substr(0,1)&&null!=d.skill[e[l]].am&&(d.skill[e[l]].attack+=.25*d.game.tree.t13);if(d.game.tree.t14>0&&(d.skill.a114.cost.k120-=1*d.game.tree.t14,d.skill.a119.cost.k120-=1*d.game.tree.t14),d.game.tree.t15>0&&(d.skill.a114.crit+=.5*d.game.tree.t15,d.skill.a119.crit+=.5*d.game.tree.t15),d.game.tree.t16>0&&(d.skill.k1115.auto=1,d.skill.k1139.auto=1,d.skill.k1228.auto=1,d.skill.k1229.auto=1,d.skill.k11524.auto=1),d.game.tree.t21>0&&(d.skill.k110.speed+=.2*d.game.tree.t21),d.game.tree.t22>0)for(var e=Object.keys(d.skill),l=0;l<e.length;l++)"e"==e[l].substr(0,1)&&(null!=d.skill[e[l]].rp&&(d.skill[e[l]].rp-=.5*d.game.tree.t22),d.skill[e[l]].rp<0&&(d.skill[e[l]].rp=0));if(d.game.tree.t23>0)for(var e=Object.keys(d.skill),l=0;l<e.length;l++)"a"==e[l].substr(0,1)&&null!=d.skill[e[l]].ap&&(d.skill[e[l]].attack+=.25*d.game.tree.t23);d.game.tree.t24,d.game.tree.t25,d.game.tree.t26>0&&(d.skill.a111.auto=1,d.skill.a112.auto=1),d.game.tree.t31>0&&(d.skill.k1114.speed+=.25*d.game.tree.t31),d.game.tree.t32,d.game.tree.t33>0&&(d.skill.a113.attack+=.25*d.game.tree.t33,d.skill.a116.attack+=.25*d.game.tree.t33),d.game.tree.t34>0&&(d.skill.a117.speed+=.1*d.game.tree.t34),d.game.tree.t35,d.game.tree.t41,d.game.tree.t42,d.game.tree.t43,d.game.tree.t44>0&&(d.skill.e113.xp+=d.game.tree.t44,d.skill.e1114.xp+=d.game.tree.t44,d.skill.e1121.xp+=d.game.tree.t44),d.game.tree.t45>0&&(d.skill.k11401.max+=10*d.game.tree.t45,d.skill.k11600.max+=10*d.game.tree.t45,d.skill.k11718.max+=10*d.game.tree.t45),d.game.tree.t51>0&&(d.skill.k110.auto=1,d.skill.k120.auto=1),d.game.tree.t52>0&&(d.skill.k1119.auto=1,d.skill.k1138.auto=1,d.skill.k11311.auto=1),d.game.tree.t54,d.game.tree.t55,d.game.tree.t56,d.game.tree.t56>0&&(d.skill.k118.auto=1,d.skill.k119.auto=1,d.skill.k1110.auto=1,d.skill.k1111.auto=1,d.skill.k1112.auto=1,d.skill.k1113.auto=1,d.skill.k111.auto=1,d.skill.k112.auto=1,d.skill.k113.auto=1,d.skill.k114.auto=1,d.skill.k115.auto=1,d.skill.k121.auto=1,d.skill.k122.auto=1,d.skill.k123.auto=1,d.skill.k1121.auto=1,d.skill.k1122.auto=1,d.skill.k1123.auto=1,d.skill.k1124.auto=1,d.skill.k1125.auto=1,d.skill.k1126.auto=1,d.skill.k1221.auto=1,d.skill.k1222.auto=1,d.skill.k1223.auto=1,d.skill.k1224.auto=1,d.skill.k1225.auto=1,d.skill.k1226.auto=1,d.skill.k1116.auto=1,d.skill.k1117.auto=1,d.skill.k1118.auto=1,d.skill.k1231.auto=1,d.skill.k1232.auto=1,d.skill.k1233.auto=1,d.skill.k11211.auto=1,d.skill.k11221.auto=1,d.skill.k11231.auto=1,d.skill.k11241.auto=1,d.skill.k11261.auto=1,d.skill.k12221.auto=1,d.skill.k12231.auto=1,d.skill.k12261.auto=1,d.skill.k12271.auto=1,d.skill.k12281.auto=1,d.skill.k11161.auto=1,d.skill.k11171.auto=1,d.skill.k11181.auto=1,d.skill.k11191.auto=1),d.skill.k110.unlock=1,d.game.ginfo_open=1,d.game.tab.open11=1,d.game.stage=0,switch_tab(),cleartabs()}function show_tree(){d.game.gtab_open=1,d.game.tab.open15=1,d.game.world.curr=1,switch_tab(5),cleartabs(),switch_stab(d.game.lastform),d.game.paused=0,savegame()}function cycle_plane(){var e=d.game.tree,l=d.skill.sp.value,a=d.game.lastform;d=null,resetgame(),d.game.pause=1,d.skill.k110.unlock=0,d.game.gtab_open=0,d.game.ginfo_open=0,d.game.tree=e,d.skill.sp.value=l,d.game.lastform=a,cleartabs(),show_tree()}function lose_plane(e=0){var l=d.game.player.lvl+1;null==d.skill.sp.max&&(d.skill.sp.max=1e4),spo=0,d.game.tree.t55>0&&(l+=spo=d.game.tree.t55),add_sp(l),story.n996.text='You have gained <b class="clr-k15a">'+l+' Soul Points (SP)</b><br><i class="smaller">+1 Base Reward<br>+'+d.game.player.lvl+" Level(s)<br>+"+spo+" Soul Sponge</i><br><br>While everything else in the game resets, SP serves as a persistent currency used to upgrade your abilities in the <b>Skill Tree</b>. These enhancements carry over across plane cycles, empowering you to grow stronger and progress further each cycle.",1==e&&add_sp(1e4),show_notice(story.n996,64,1),cycle_plane()}function win_plane(){lose_plane(1)}function win_fight(e){var l=d.skill[e].xp;d.game.tree.t43>0&&("e113"==e||"e1114"==e||"e1121"==e)&&(l+=d.game.tree.t44),add_xp(l),d.game.tree.t42>0&&("e113"==e&&(d.skill.k110.max+=.5*d.game.tree.t42),"e1114"==e&&(d.skill.k120.max+=.5*d.game.tree.t42)),story.n997.text="You have gained "+d.skill[e].xp+" XP.",show_notice(story.n997),d.game.battle=null,lskill(e),d.skill[e].value=0,gebi("gmain").innerHTML=""}function save_lastform(){1==d.skill.k116.unlock&&(d.game.lastform=1),1==d.skill.k117.unlock&&(d.game.lastform=2),1==d.skill.k1136.unlock&&(d.game.lastform=3),1==d.skill.k11616.unlock&&(d.game.lastform=4)}function add_xp(e){for(d.game.tree.t54>0&&(e+=d.game.tree.t54),d.skill.xp.curr+=e;d.skill.xp.curr>=d.skill.xp.need;)d.skill.xp.curr-=d.skill.xp.need,d.game.player.lvl++,d.game.player.nxp*=2,d.skill.xp.need=d.game.player.nxp}function minus_xp(e){d.skill.xp.curr-=e,d.skill.xp.curr<0&&(d.skill.xp.curr=0)}function add_sp(e){d.skill.sp.value+=e,d.skill.sp.value>d.skill.sp.max&&(d.skill.sp.value=d.skill.sp.max)}function can_sp(e){return d.game.stage<62?0:d.skill.sp.value>=e?1:0}function use_sp(e){d.skill.sp.value-=e,d.skill.sp.value<0&&(d.skill.sp.value=0)}function bonus_ap(e){var l=0;return 1==d.skill.k115221.value&&null!=d.skill[e].ap&&(l+=1),1==d.skill.k115222.value&&null!=d.skill[e].ap&&(l+=1),1==d.skill.k115223.value&&null!=d.skill[e].ap&&(l+=1),l}function bonus_am(e){var l=0;return 1==d.skill.k115231.value&&null!=d.skill[e].am&&(l+=1),1==d.skill.k115232.value&&null!=d.skill[e].am&&(l+=1),1==d.skill.k115233.value&&null!=d.skill[e].am&&(l+=1),l}function bonus_cr(){var e=0;return 1==d.skill.k11526.unlock&&(e+=10),d.game.tree.t32>0&&(e+=d.game.tree.t32),e}function attack(e){if(null!=d.game.battle){var l=d.skill[d.game.battle];(r=d.skill[e]).value=0,0==l.running&&(l.running=1);var a=Math.floor(100*Math.random())+1,i='<img src="img/ico-dice.png"> '+(100-a)+"% &nbsp; ";if(a<=r.acc){var s=d.skill[e].attack;s+=bonus_ap(e),s+=bonus_am(e),a<=5+bonus_cr()&&(s*=d.skill[e].crit);var n=0;null!=l.rp&&null!=d.skill[e].ap&&((s-=l.rp)<0&&(s=0),n=d.skill[d.game.battle].rp),null!=l.rm&&null!=d.skill[e].am&&((s-=l.rm)<0&&(s=0),n=d.skill[d.game.battle].rm),l.curr+=s,checkmax_c(d.game.battle),i+=(a<=5?"CRITICAL":"HIT")+' <b class="bigger red">'+s+"</b> "+(n>0?" (RESISTED "+n+")":""),null!=gebi("gudice-"+e)&&gebi("gudice-"+e).classList.remove("atkmiss")}else i+="MISS",null!=gebi("gudice-"+e)&&gebi("gudice-"+e).classList.add("atkmiss");null!=gebi("gudice-"+e)&&(gebi("gudice-"+e).innerHTML=i,setTimeout("clear('gudice-"+e+"')",700)),d.skill[d.game.battle].curr>=d.skill[d.game.battle].need&&click_skill(d.game.battle)}}function check_cost(e){var l=d.skill[e];if(null==l.cost)return 1;for(var a=Object.keys(l.cost),i=0;i<a.length;i++)if(d.skill[a[i]].value<d.skill[e].cost[a[i]])return 0;return 1}function consume_cost(e){for(var l=Object.keys(d.skill[e].cost),a=0;a<l.length;a++){var i=d.skill[l[a]];i.value-=d.skill[e].cost[l[a]]}}function trybuy(e=""){if(!(d.game.stage<62)){if(buying!=e&&hide("ttbuy-"+buying),""!=e){var l=get_stabcost(e);d.game.tree[e]<tree[e].max&&can_sp(l)?show("ttbuy-"+(buying=e)):hide("ttbuy-"+buying)}}}function performbuy(e){if(!(d.game.stage<62)){var l=get_stabcost(e);can_sp(l)&&(use_sp(l),up_stab(e)),hide("ttbuy-"+e)}}function get_stabcost(e){return null==tree[e]?0:(tree[e].cost+tree[e].cost*d.game.tree[e])*(stab==d.game.lastform||5==stab?1:2)}function up_stab(e){!(d.game.stage<62)&&(d.game.tree[e]++,d.game.tree[e]>tree[e].max&&(d.game.tree[e]=tree[e].max))}function round(e){return Math.round(e)}function round2(e){return Math.round(100*e)/100}function stotime(e){return t="",e>3600&&(h=Math.floor(e/3600),e-=3600*h,t+=h+"h "),e>60&&(m=Math.floor(e/60),e-=60*m,t+=m+"m "),t+=round2(e)+"s"}function gebi(e){return document.getElementById(e)}function show(e){null!=gebi(e)&&""!=gebi(e).style.display&&(gebi(e).style.display="")}function hide(e){null!=gebi(e)&&"none"!=gebi(e).style.display&&(gebi(e).style.display="none")}function clear(e){null!=gebi(e)&&(gebi(e).innerHTML="")}function add_story(e){var l=0;null!=d.game.story&&(l=Object.keys(d.game.story).length),d.game.story["p"+l]=e}function load_story(){for(var e="",l=Object.keys(d.game.story),a=0;a<l.length;a++)e+=story[d.game.story[l[a]]].text+"<br><br>";gebi("gnstory").innerHTML=e}function show_notice(e,l=0,a=0){d.game.tree.t57>0&&l<61&&0==a?d.game.next_stage=l:(d.game.paused=1,d.game.next_stage=l,gebi("gnbtn").value="继续",gebi("gntitle").innerHTML=e.title,gebi("gntext").innerHTML=e.text,gebi("visual").src=null==e.img?"":"img/"+e.img,show("gnoverlay"),show("gnotice"),window.scrollTo(0,0))}function close_notice(){0!=d.game.next_stage&&stage_check(),d.game.paused=0,hide("gnotice"),hide("gnoverlay"),window.scrollTo(0,0)}function cleartabs(){gebi("ginfo").innerHTML="",gebi("gtab").innerHTML="",gebi("gmain").innerHTML="",changed_tab=1}function resetgame(){resetting=1,d=null,localStorage.setItem(storage_marker,null),loadgame();for(var e=Object.keys(d.skill),l=0;l<e.length;l++)d.skill[e[l]].value=0;cleartabs()}function exportgame(){savegame();var e=JSON.parse(localStorage.getItem(storage_marker));navigator.clipboard.writeText(JSON.stringify(e)),gebi("imexinfo").innerHTML="Exported to clipboard."}function importgame(){var e=prompt("Paste your game data:");null!=e&&""!=e&&(localStorage.setItem(storage_marker,e),loadgame(),hide("gmisc2"),hide("gnoverlay"))}function savegame(){localStorage.setItem(storage_marker,JSON.stringify(d))}function loadgame(){var e=JSON.parse(localStorage.getItem(storage_marker));null==e?init_d():(d=e,init_s()),cleartabs()}function startgame(){loadgame(),switch_tab(d.game.tab["curr"+d.game.world.curr]),0==loop_inited&&(loop_inited=1,gameloop(),update_ui(),update_ui_delay())}function init_s(){for(var e=init_d(1),l=Object.keys(e.skill),a=0;a<l.length;a++)null==d.skill[l[a]]&&(d.skill[l[a]]=e.skill[l[a]])}var bgm=null;function first_tap(){1!=interacted&&(interacted=1,(bgm=new Audio("sound/bgm.mp3")).loop=!0,bgm.addEventListener("ended",function(){this.currentTime=0,this.play()},!1),gebi("svolume").value=d.game.volume,toggle_volume(d.game.muted),do_volume(d.game.volume),0==d.game.muted&&bgm.play())}function do_volume(e){bgm.volume=e/100,d.game.volume=e}function toggle_volume(e=-1){e>-1?d.game.muted=e:d.game.muted=1==d.game.muted?0:1,1==(v=d.game.muted)?(bgm.pause(),gebi("imute").src="img/ico-v0.png"):(1==interacted&&bgm.play(),gebi("imute").src="img/ico-v1.png")}